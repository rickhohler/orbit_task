name: Publish to Pub.dev

on:
  push:
    tags:
      - 'v*' # Publish on any v-tag

jobs:
  publish:
    name: Publish to Pub.dev
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      id-token: write # Required for authentication with pub.dev

    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - uses: dart-lang/setup-dart@v1
      
      - name: Publish Packages
        run: |
          # Publish order matters: dependency leaves first.
          
          # 1. Annotations (independent)
          (cd packages/orbit_task_annotations && dart pub publish -f)
          
          # 2. Platform Interface (depends on nothing or core flutter)
          (cd packages/orbit_task_platform_interface && dart pub publish -f)
          
          # 3. Generator (depends on annotations)
          (cd packages/orbit_task_generator && dart pub publish -f)
          
          # 4. Implementations (depend on platform interface)
          (cd packages/orbit_task_android && dart pub publish -f)
          (cd packages/orbit_task_ios && dart pub publish -f)
          (cd packages/orbit_task_web && dart pub publish -f)
          
          # 5. Facade (depends on everything)
          (cd packages/orbit_task && dart pub publish -f)
